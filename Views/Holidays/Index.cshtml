@using BulgarianTraditionsAndCustoms.ViewModels.Holidays
@model HolidayIndexViewModel

@{
	ViewData["Title"] = "Празници";
	ViewData["BodyClass"] = "home-page";
	var prevDisabled = !Model.Holidays.HasPreviousPage ? "disabled" : "";
	var nextDisabled = !Model.Holidays.HasNextPage ? "disabled" : "";
}

<section class="index-hero holidays-hero text-center text-white position-relative shadow-lg mb-5">
	<div class="hero-overlay"></div>
	<div class="hero-content position-relative">
		<h1 class="display-5 fw-bold text-white mb-0">Български празници</h1>
	</div>
</section>

<div class="container traditions-page holidays-page">

	<!-- Separator -->
	<div class="text-center p-0 my-5">
		<img src="~/images/separator.png" class="img-separator" alt="Bulgarian Pattern Separator" />
	</div>

	<div class="row">
		<!-- Sidebar (Left Column) -->
		<aside class="col-lg-4 mb-5 mb-lg-0">
			<div class="glass-panel sticky-top" style="top: 100px; z-index: 10;">
				<h4 class="fw-bold mb-4"><i class="bi bi-funnel-fill me-2 text-success"></i>Филтри</h4>

				<form asp-controller="Holidays" asp-action="Index" method="get" id="filter">
					
					<!-- Search -->
					<div class="mb-4">
						<label class="form-label fw-bold small text-muted text-uppercase">Търсене</label>
						<div class="input-group search-pill-group">
							<button type="submit" class="input-group-text bg-white border-end-0 ps-3">
								<i class="bi bi-search text-muted"></i>
							</button>
							<input type="text" name="searchString" value="@Model.FilterQuery.SearchString" class="form-control border-start-0" placeholder="Търси по име..." />
						</div>
					</div>

					<!-- Period -->
					<div class="mb-4">
						<label class="form-label fw-bold small text-muted text-uppercase">Период</label>
						<div class="d-flex gap-2">
							<input type="date" name="dateFrom" value="@Model.FilterQuery.DateFrom?.ToString("yyyy-MM-dd")" class="form-control" placeholder="От">
							<input type="date" name="dateTo" value="@Model.FilterQuery.DateTo?.ToString("yyyy-MM-dd")" class="form-control" placeholder="До">
						</div>
					</div>

					<div class="d-grid gap-2 mt-3">
						<button type="submit" class="btn btn-green rounded-pill py-2 fw-bold shadow-sm">
							Приложи филтри
						</button>
						<a asp-action="Index" 
						   asp-route-searchString="@Model.FilterQuery.SearchString"
						   asp-route-pageSize="@Model.FilterQuery.PageSize" 
						   asp-route-sortOrder="@Model.FilterQuery.SortOrder"
						   class="btn btn-red-outline btn-sm rounded-pill py-1 fw-bold">
							Изчисти всички
						</a>
					</div>
				</form>
			</div>
		</aside>

		<!-- Main Content (Right Column) -->
		<main class="col-lg-8">

			<!-- Controls Bar -->
			<div class="d-flex flex-wrap justify-content-between align-items-center mb-4 p-3 glass-panel rounded-pill py-2 controls-bar">
				<div class="mb-2 mb-md-0 px-2">
					@if (User.IsInRole("Admin"))
					{
						<a asp-action="Create" class="btn btn-green rounded-pill"><i class="bi bi-plus-lg me-1"></i> Създай статия</a>
					}
				</div>

				<div class="d-flex gap-3 align-items-center">
					<!-- Page Size -->
					<div class="dropdown">
						<button class="btn btn-sm btn-light rounded-pill dropdown-toggle px-3" type="button" data-bs-toggle="dropdown">
							Покажи: @Model.FilterQuery.PageSize
						</button>
						<ul class="dropdown-menu shadow border-0">
							<li><a class="dropdown-item @(Model.FilterQuery.PageSize == 5 ? "active" : "")" asp-action="Index" asp-route-pageSize="5" asp-route-searchString="@Model.FilterQuery.SearchString" asp-route-dateFrom="@Model.FilterQuery.DateFrom" asp-route-dateTo="@Model.FilterQuery.DateTo" asp-route-sortOrder="@Model.FilterQuery.SortOrder">5</a></li>
							<li><a class="dropdown-item @(Model.FilterQuery.PageSize == 10 ? "active" : "")" asp-action="Index" asp-route-pageSize="10" asp-route-searchString="@Model.FilterQuery.SearchString" asp-route-dateFrom="@Model.FilterQuery.DateFrom" asp-route-dateTo="@Model.FilterQuery.DateTo" asp-route-sortOrder="@Model.FilterQuery.SortOrder">10</a></li>
							<li><a class="dropdown-item @(Model.FilterQuery.PageSize == 15 ? "active" : "")" asp-action="Index" asp-route-pageSize="15" asp-route-searchString="@Model.FilterQuery.SearchString" asp-route-dateFrom="@Model.FilterQuery.DateFrom" asp-route-dateTo="@Model.FilterQuery.DateTo" asp-route-sortOrder="@Model.FilterQuery.SortOrder">15</a></li>
						</ul>
					</div>

					<!-- Sort -->
					<div class="dropdown">
						<button class="btn btn-sm btn-white border rounded-pill dropdown-toggle px-3" type="button" data-bs-toggle="dropdown">
							<i class="bi bi-sort-down me-1"></i> Сортиране
						</button>
						<ul class="dropdown-menu shadow border-0 dropdown-menu-end">
							<li><a class="dropdown-item @(Model.FilterQuery.SortOrder == "name_asc" ? "active" : "")" asp-action="Index" asp-route-searchString="@Model.FilterQuery.SearchString" asp-route-dateFrom="@Model.FilterQuery.DateFrom" asp-route-dateTo="@Model.FilterQuery.DateTo" asp-route-pageSize="@Model.FilterQuery.PageSize" asp-route-sortOrder="name_asc">Име (А-Я)</a></li>
							<li><a class="dropdown-item @(Model.FilterQuery.SortOrder == "name_desc" ? "active" : "")" asp-action="Index" asp-route-searchString="@Model.FilterQuery.SearchString" asp-route-dateFrom="@Model.FilterQuery.DateFrom" asp-route-dateTo="@Model.FilterQuery.DateTo" asp-route-pageSize="@Model.FilterQuery.PageSize" asp-route-sortOrder="name_desc">Име (Я-А)</a></li>
							<li><a class="dropdown-item @(Model.FilterQuery.SortOrder == "upcoming" ? "active" : "")" asp-action="Index" asp-route-searchString="@Model.FilterQuery.SearchString" asp-route-dateFrom="@Model.FilterQuery.DateFrom" asp-route-dateTo="@Model.FilterQuery.DateTo" asp-route-pageSize="@Model.FilterQuery.PageSize" asp-route-sortOrder="upcoming">Предстоящи</a></li>
						</ul>
					</div>
				</div>
			</div>

			<!-- List Layout -->
			<div class="row g-4">
				@foreach (var item in Model.Holidays)
				{
					<div class="col-12">
						<div class="card tradition-card h-100 shadow-sm border-0 overflow-hidden">
							<div class="row g-0 h-100">
								<div class="col-md-3">
									<div class="date-ribbon">
										<div class="day">@item.CelebrationDate?.Day</div>
										<div class="month">@item.CelebrationDate?.ToString("MMMM", new System.Globalization.CultureInfo("bg-BG"))</div>
									</div>
								</div>
								<div class="col-md-9">
									<div class="card-body h-100 d-flex flex-column p-4">
										<div class="d-flex justify-content-between align-items-start mb-3">
											<div>
												<h4 class="card-title fw-bold mb-1">@item.Name</h4>
												@if (item.Traditions != null && item.Traditions.Any())
												{
													<span class="badge rounded-pill border border-success text-success px-3 py-2 small fw-normal">
														<i class="bi bi-link-45deg me-1"></i> @item.Traditions.Count свързани традиции
													</span>
												}
											</div>
											@if (User.IsInRole("Admin"))
											{
												<div class="dropdown">
													<button class="btn btn-link text-muted p-0" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
													<ul class="dropdown-menu dropdown-menu-end shadow border-0">
														<li><a class="dropdown-item" asp-action="Edit" asp-route-id="@item.Id"><i class="bi bi-pencil me-2"></i> Редактиране</a></li>
														<li><button class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#deleteModal-@item.Id"><i class="bi bi-trash me-2"></i> Изтриване</button></li>
													</ul>
												</div>
											}
										</div>

										<p class="card-text text-secondary mb-4 flex-grow-1">
											@(item.Description != null && item.Description.Length > 140 ? item.Description.Substring(0, 140) + "(...)" : item.Description)
										</p>

										<div class="mt-auto d-flex">
											<a asp-action="Details" asp-route-id="@item.Id" class="btn btn-red rounded-pill px-4 shadow-sm fw-bold ms-auto">
												Прочети още
											</a>
										</div>
									</div>
								</div>
							</div>
						</div>
						@if (User.IsInRole("Admin"))
						{
							<partial name="_DeleteModal" model='new DeleteModalViewModel { Id = item.Id, EntityName = item.Name, DisplayTitle = "празника", Controller = "Holidays" }' />
						}
					</div>
				}
			</div>

			<!-- Pagination -->
			<div class="d-flex justify-content-center mt-5">
				<nav>
					<ul class="pagination">
						<li class="page-item @prevDisabled">
							<a asp-action="Index"
							   asp-route-searchString="@Model.FilterQuery.SearchString"
							   asp-route-dateFrom="@Model.FilterQuery.DateFrom"
							   asp-route-dateTo="@Model.FilterQuery.DateTo"
							   asp-route-pageSize="@Model.FilterQuery.PageSize"
							   asp-route-sortOrder="@Model.FilterQuery.SortOrder"
							   asp-route-pageNumber="@(Model.Holidays.PageIndex - 1)"
							   class="page-link rounded-pill me-2 border-0 shadow-sm">
								<i class="bi bi-chevron-left"></i>
							</a>
						</li>

						@for (var i = 1; i <= Model.Holidays.TotalPages; i++)
						{
							<li class="page-item @(i == Model.Holidays.PageIndex ? "active" : "")">
								<a class="page-link rounded-pill mx-1 border-0 shadow-sm @(i == Model.Holidays.PageIndex ? "bg-green text-white" : "text-forest")"
								   asp-action="Index"
								   asp-route-searchString="@Model.FilterQuery.SearchString"
								   asp-route-dateFrom="@Model.FilterQuery.DateFrom"
								   asp-route-dateTo="@Model.FilterQuery.DateTo"
								   asp-route-pageSize="@Model.FilterQuery.PageSize"
								   asp-route-sortOrder="@Model.FilterQuery.SortOrder"
								   asp-route-pageNumber="@i">
									@i
								</a>
							</li>
						}

						<li class="page-item @nextDisabled">
							<a asp-action="Index"
							   asp-route-searchString="@Model.FilterQuery.SearchString"
							   asp-route-dateFrom="@Model.FilterQuery.DateFrom"
							   asp-route-dateTo="@Model.FilterQuery.DateTo"
							   asp-route-pageSize="@Model.FilterQuery.PageSize"
							   asp-route-sortOrder="@Model.FilterQuery.SortOrder"
							   asp-route-pageNumber="@(Model.Holidays.PageIndex + 1)"
							   class="page-link rounded-pill ms-2 border-0 shadow-sm">
								<i class="bi bi-chevron-right"></i>
							</a>
						</li>
					</ul>
				</nav>
			</div>

		</main>
	</div>
</div>
